# Railway デプロイ手順書

## 🚂 Railway でのデプロイ方法

### 1. Railway アカウント作成・ログイン

1. [Railway](https://railway.app/)にアクセス
2. GitHub アカウントでサインアップ/ログイン
3. 別のアカウントを使用する場合は、ログアウト後に新しいアカウントでログイン

### 2. プロジェクトのデプロイ

1. Railway ダッシュボードで「New Project」をクリック
2. 「Deploy from GitHub repo」を選択
3. このプロジェクトのリポジトリを選択してインポート
4. Railway が自動的に `railway.toml` を検出してビルド設定を適用

### 3. 環境変数の設定

Railway ダッシュボードの「Variables」タブで以下を設定：

#### 必須設定

| 変数名           | 値の例                             | 説明                                |
| ---------------- | ---------------------------------- | ----------------------------------- |
| `SESSION_SECRET` | `Tn-0904-1021-1055-0117-0430-0904` | セッション暗号化キー（32 文字以上） |
| `NODE_ENV`       | `production`                       | 本番環境設定                        |
| `PORT`           | `3000`                             | アプリケーションポート              |

#### セキュリティ設定（推奨）

| 変数名                 | 値の例                          | 説明                 |
| ---------------------- | ------------------------------- | -------------------- |
| `ADMIN_PROMOTION_PASS` | `your-admin-promotion-password` | 管理者昇格パスワード |

#### メール設定（オプション）

| 変数名         | 値の例                                  | 説明             |
| -------------- | --------------------------------------- | ---------------- |
| `SMTP_HOST`    | `smtp.gmail.com`                        | SMTP ホスト      |
| `SMTP_PORT`    | `587`                                   | SMTP ポート      |
| `SMTP_USER`    | `your-email@gmail.com`                  | メールアドレス   |
| `SMTP_PASS`    | `your-app-password`                     | アプリパスワード |
| `ADMIN_EMAILS` | `admin1@company.com,admin2@company.com` | 管理者メール     |

### 4. データベース設定

#### オプション 1: SQLite（簡単・開発用）

- デフォルトで SQLite を使用
- データは永続ボリューム（`/app/data`）に保存
- 小規模運用に適している

#### オプション 2: PostgreSQL（推奨・本格運用）

1. Railway ダッシュボードで「New」→「Database」→「PostgreSQL」を追加
2. 自動生成される `DATABASE_URL` を環境変数に設定
3. アプリケーションが自動的に PostgreSQL を使用

### 5. デプロイの実行

1. 環境変数設定後、自動的にデプロイが開始
2. デプロイログを「Deployments」タブで確認
3. 完了後、Railway が提供する URL でアクセス可能
4. 形式: `https://your-project-name.up.railway.app`

## 🔒 セキュリティ設定

### 必須セキュリティ対策

1. **SESSION_SECRET の設定**

   ```bash
   # 強力なランダム文字列を生成
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```

2. **初期管理者パスワードの変更**

   - デプロイ後、必ず初期パスワード（admin/admin）を変更
   - パスワードは 8 文字以上を推奨

3. **HTTPS の確認**
   - Railway は自動的に HTTPS を有効化
   - カスタムドメインでも SSL 証明書が自動適用

### 本番環境での変更点

- **パスワードハッシュ化**: 本番環境では SHA-256 でハッシュ化
- **セキュリティヘッダー**: CSP、XSS Protection 等が自動適用
- **セッション設定**: HTTPS 必須、セキュアクッキー有効

## 📊 Railway の特徴・利点

### Vercel との違い

| 項目                     | Railway             | Vercel             |
| ------------------------ | ------------------- | ------------------ |
| **データベース**         | 永続ストレージ対応  | 読み取り専用 FS    |
| **ファイルアップロード** | 永続ボリューム対応  | 外部ストレージ必要 |
| **セッション**           | メモリ/ファイル対応 | 外部ストア推奨     |
| **料金**                 | 使用量ベース        | 関数実行ベース     |
| **スケーリング**         | 垂直・水平          | 自動水平           |

### Railway の利点

1. **永続データ**: SQLite ファイルが永続化される
2. **ファイルアップロード**: アップロードファイルが保持される
3. **セッション管理**: メモリベースセッションが機能する
4. **簡単設定**: 複雑な外部サービス連携不要

## 🔄 継続的デプロイ

GitHub リポジトリにプッシュすると自動的にデプロイされます：

```bash
git add .
git commit -m "更新内容"
git push origin main
```

## 🛠️ トラブルシューティング

### よくある問題

1. **デプロイが失敗する**

   - `railway.toml` の設定を確認
   - 環境変数 `SESSION_SECRET` が設定されているか確認
   - デプロイログでエラー詳細を確認

2. **データベース接続エラー**

   - PostgreSQL 使用時は `DATABASE_URL` が正しく設定されているか確認
   - SQLite 使用時はボリュームマウントが正しいか確認

3. **ファイルアップロードが失敗**

   - ボリューム設定（`/app/data`）が正しいか確認
   - アップロード先ディレクトリの権限を確認

4. **セッションが保持されない**
   - `SESSION_SECRET` が設定されているか確認
   - HTTPS 環境での Cookie 設定を確認

### ログの確認方法

1. Railway ダッシュボード
2. プロジェクト選択
3. 「Deployments」タブでビルド・デプロイログを確認
4. 「Metrics」タブでアプリケーションログを確認

## 🎯 本番運用時の推奨改善

### 短期（すぐに実施）

1. **パスワード変更**: 初期管理者パスワードの変更
2. **SESSION_SECRET**: 強力なランダム文字列に変更
3. **管理者昇格パスワード**: ADMIN_PROMOTION_PASS の設定

### 中期（1-2 週間以内）

1. **データベース移行**: PostgreSQL への移行（推奨）
2. **メール通知**: SMTP 設定でリアルタイム通知
3. **バックアップ**: 定期的なデータエクスポート
4. **カスタムドメイン**: 独自ドメインの設定

### 長期（1-3 ヶ月以内）

1. **監視**: Railway Metrics の活用
2. **スケーリング**: 負荷に応じたリソース調整
3. **セキュリティ**: 定期的なセキュリティ監査
4. **CDN**: 静的ファイル配信の最適化

## 💰 料金について

### Railway の料金体系

- **Hobby Plan**: $5/月（個人・小規模プロジェクト）
- **Pro Plan**: $20/月（チーム・本格運用）
- **使用量ベース**: CPU 時間、メモリ、ストレージ、帯域幅

### コスト最適化

1. **リソース監視**: Metrics でリソース使用量を定期確認
2. **自動スリープ**: 非アクティブ時の自動スリープ設定
3. **効率的なコード**: 不要な処理の削減

## 🔗 参考リンク

- [Railway 公式ドキュメント](https://docs.railway.app/)
- [Railway テンプレート](https://railway.app/templates)
- [Node.js デプロイガイド](https://docs.railway.app/guides/nodejs)
- [PostgreSQL 設定](https://docs.railway.app/databases/postgresql)
