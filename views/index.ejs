<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>店舗管理システム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body class="container py-5">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">店舗管理システム</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <% if (typeof session !== 'undefined' && session && session.user &&
            session.user.role === 'admin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/stores/list">店舗一覧</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups/list">グループ管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/api/users/list">アカウント管理</a>
            </li>
            <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && session.user.role === 'agency') { %>
            <li class="nav-item">
              <a class="nav-link text-warning" href="/auth/promote"
                >管理者・役員に切り替え</a
              >
            </li>
            <% if (session.user.store_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/stores/profile/<%= session.user.store_id %>"
                >マイプロフィール</a
              >
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <% if (session.user.store_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/materials/<%= session.user.store_id %>"
                >商品資料格納庫</a
              >
            </li>
            <% } %> <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && (session.user.role === 'admin')) { %> <% } %> <% if
            (typeof session !== 'undefined' && session && session.user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">ログアウト</a>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/login">ログイン</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

    <div class="card shadow-sm p-4 mb-4">
      <h1 class="mb-3">店舗管理システム</h1>
      <p class="mb-4">店舗管理システムへようこそ。</p>

      <!-- 管理者向けメニュー -->
      <% if (session && session.user && session.user.role === 'admin') { %>
      <div class="mb-3">
        <h5>管理者機能</h5>
        <div class="d-flex gap-2 flex-wrap">
          <a href="/stores/list" class="btn btn-info">店舗一覧</a>
          <a href="/sales/list" class="btn btn-primary">売上管理</a>
        </div>
      </div>
      <% } %>

      <!-- 店舗ユーザー向けメニュー -->
      <% if (session && session.user && session.user.role === 'agency') { %>
      <div class="mb-3">
        <h5>店舗機能</h5>
        <% if (session.user.store_id) { %>
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <div class="card h-100">
              <div class="card-body text-center">
                <i class="bi bi-person-circle fs-1 text-primary"></i>
                <h6 class="card-title mt-2">マイプロフィール</h6>
                <p class="card-text text-muted">個人情報や取り扱い商品を管理</p>
                <a
                  href="/stores/profile/<%= session.user.store_id %>"
                  class="btn btn-outline-primary"
                >
                  プロフィール表示
                </a>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card h-100">
              <div class="card-body text-center">
                <i class="bi bi-graph-up fs-1 text-success"></i>
                <h6 class="card-title mt-2">売上管理</h6>
                <p class="card-text text-muted">月間売上の入力・確認</p>
                <a href="/sales/list" class="btn btn-outline-success"
                  >売上管理</a
                >
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card h-100">
              <div class="card-body text-center">
                <i class="bi bi-folder-fill fs-1 text-info"></i>
                <h6 class="card-title mt-2">商品資料格納庫</h6>
                <p class="card-text text-muted">商品資料の閲覧・ダウンロード</p>
                <a
                  href="/materials/<%= session.user.store_id %>"
                  class="btn btn-outline-info"
                >
                  資料を見る
                </a>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6">
            <div class="card h-100" id="admin-url-card" style="display: none">
              <div class="card-body text-center">
                <i class="bi bi-chat-dots fs-1 text-success"></i>
                <h6 class="card-title mt-2">公式ライン</h6>
                <p class="card-text text-muted">公式LINEでサポート</p>
                <a
                  href="#"
                  id="admin-url-link"
                  target="_blank"
                  class="btn btn-success"
                >
                  <i class="bi bi-chat-dots"></i> 公式LINEへ
                </a>
              </div>
            </div>
          </div>
        </div>
        <% } else { %>
        <div class="alert alert-warning mb-4">
          <h6>
            <i class="bi bi-exclamation-triangle"></i>
            プロフィール設定が必要です
          </h6>
          <p class="mb-3">
            店舗機能を利用するには、まず店舗プロフィールを作成してください。
          </p>
          <a href="/stores/create-profile" class="btn btn-primary">
            <i class="bi bi-person-plus"></i> プロフィールを作成
          </a>
        </div>

        <!-- プロフィール未作成時でも公式ラインボタンを表示 -->
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <div
              class="card h-100"
              id="admin-url-card-no-profile"
              style="display: none"
            >
              <div class="card-body text-center">
                <i class="bi bi-chat-dots fs-1 text-success"></i>
                <h6 class="card-title mt-2">公式ライン</h6>
                <p class="card-text text-muted">公式LINEでサポート</p>
                <a
                  href="#"
                  id="admin-url-link-no-profile"
                  target="_blank"
                  class="btn btn-success"
                >
                  <i class="bi bi-chat-dots"></i> 公式LINEへ
                </a>
              </div>
            </div>
          </div>
        </div>
        <% } %>
      </div>
      <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 管理者設定URL取得・表示 -->
    <% if (session && session.user && session.user.role === 'agency') { %>
    <script>
      // 店舗ユーザーのみ公式LINE URLリンクを取得・表示
      console.log("=== 公式LINE URL取得開始 ===");
      console.log("APIエンドポイント: /settings/api/official-line-url");

      fetch("/settings/api/official-line-url")
        .then((response) => {
          console.log("APIレスポンス状態:", response.status);
          console.log("APIレスポンスOK:", response.ok);
          return response.json();
        })
        .then((data) => {
          console.log("取得したデータ:", data);
          console.log("URL:", data.url);

          if (data.url) {
            console.log("公式LINE URLが設定されています:", data.url);

            // プロフィール作成済み用のボタン
            const linkElement = document.getElementById("admin-url-link");
            const cardElement = document.getElementById("admin-url-card");

            // プロフィール未作成用のボタン
            const linkElementNoProfile = document.getElementById(
              "admin-url-link-no-profile"
            );
            const cardElementNoProfile = document.getElementById(
              "admin-url-card-no-profile"
            );

            // プロフィール作成済み用ボタンの制御
            if (linkElement && cardElement) {
              linkElement.href = data.url;
              cardElement.style.display = "block";
              console.log("公式LINE URLカードを表示しました");
            }

            // プロフィール未作成用ボタンの制御
            if (linkElementNoProfile && cardElementNoProfile) {
              linkElementNoProfile.href = data.url;
              cardElementNoProfile.style.display = "block";
              console.log("公式LINE URLカード（no-profile）を表示しました");
            }

            // どちらも見つからない場合のエラーログ
            if (
              !linkElement &&
              !cardElement &&
              !linkElementNoProfile &&
              !cardElementNoProfile
            ) {
              console.error("HTML要素が見つかりません:", {
                linkElement: !!linkElement,
                cardElement: !!cardElement,
                linkElementNoProfile: !!linkElementNoProfile,
                cardElementNoProfile: !!cardElementNoProfile,
              });
            }
          } else {
            console.log("公式LINE URLが設定されていません");
          }
        })
        .catch((error) => {
          console.error("管理者設定URL取得エラー:", error);
        });
    </script>
    <% } %>
  </body>
</html>
