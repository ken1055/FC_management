<% layout('layout', { title: '代理店一覧', session: session }) %>
<div class="card shadow-sm p-4 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">代理店一覧</h1>
    <a href="/agencies/new" class="btn btn-success">
      <i class="bi bi-person-plus"></i> 新規登録
    </a>
  </div>

  <!-- 成功・エラーメッセージ -->
  <% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success alert-dismissible fade show">
    <i class="bi bi-check-circle"></i> <%= success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %>
  <% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle"></i> <%= error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %>
  
  <!-- グループフィルタリング -->
  <div class="mb-3">
    <form method="get" class="row g-2 align-items-center">
      <div class="col-auto">
        <label class="form-label">グループで絞り込み:</label>
      </div>
      <div class="col-auto">
        <select name="group_id" class="form-select">
          <option value="">すべて</option>
          <% groups.forEach(g => { %>
          <option value="<%= g.id %>" <%= selectedGroupId == g.id ? 'selected' : '' %>>
            <%= g.name %>
          </option>
          <% }) %>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">絞り込み</button>
      </div>
      <div class="col-auto">
        <a href="/groups/list" class="btn btn-outline-info">
          <i class="bi bi-collection"></i> グループ管理
        </a>
      </div>
    </form>
  </div>
  
  <!-- 代理店が存在しない場合の表示 -->
  <% if (agencies.length === 0) { %>
  <div class="text-center py-5">
    <i class="bi bi-building fs-1 text-muted"></i>
    <h5 class="mt-3 text-muted">代理店がありません</h5>
    <p class="text-muted">最初の代理店を登録してください。</p>
    <a href="/agencies/new" class="btn btn-primary">
      <i class="bi bi-person-plus"></i> 代理店を登録
    </a>
  </div>
  <% } else { %>

  <!-- 横スクロール対応のテーブル -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>名前</th>
          <th>年齢</th>
          <th>住所</th>
          <th>振込先情報</th>
          <th>経験年数</th>
          <th>契約日</th>
          <th>活動開始日</th>
          <th>商品の特徴</th>
          <th>取り扱い商品</th>
          <th>グループ</th>
          <th>商品資料格納庫</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% agencies.forEach(a => { %>
        <tr>
          <td><%= a.id %></td>
          <td>
            <a href="/agencies/profile/<%= a.id %>" class="text-decoration-none fw-bold">
              <i class="bi bi-person-circle text-primary me-1"></i>
              <%= a.name %>
            </a>
          </td>
          <td><%= a.age || '未設定' %></td>
          <td><%= a.address || '未設定' %></td>
          <td><%= a.bank_info || '未設定' %></td>
          <td><%= a.experience_years || '未設定' %>年</td>
          <td><%= a.contract_date || '未設定' %></td>
          <td><%= a.start_date || '未設定' %></td>
          <td><%= a.product_features || '未設定' %></td>
          <td><%= a.product_names || '未設定' %></td>
          <td>
            <% if (a.group_name) { %>
              <span class="badge bg-info"><%= a.group_name %></span>
            <% } else { %>
              <span class="text-muted">未設定</span>
            <% } %>
          </td>
          <td>
            <a href="/materials/<%= a.id %>" class="btn btn-sm btn-success">
              <i class="bi bi-folder"></i> 資料を見る
            </a>
          </td>
          <td>
            <div class="btn-group-vertical" role="group">
              <a href="/agencies/profile/<%= a.id %>" class="btn btn-sm btn-outline-info mb-1">
                <i class="bi bi-eye"></i> 詳細
              </a>
              <a href="/agencies/edit/<%= a.id %>" class="btn btn-sm btn-outline-primary mb-1">
                <i class="bi bi-pencil"></i> 編集
              </a>
              <form 
                method="post" 
                action="/agencies/delete/<%= a.id %>" 
                style="display: inline"
                onsubmit="return confirm('「<%= a.name %>」の代理店データを削除しますか？\n\n注意: 以下のデータもすべて削除されます：\n• 売上データ\n• 商品資料\n• グループ所属情報\n• 取り扱い商品情報\n• 関連ユーザーアカウントとの紐付け\n\n削除後、代理店IDが自動的に再割り当てされ連番が維持されます。\n\nこの操作は取り消せません。')"
              >
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash"></i> 削除
                </button>
              </form>
            </div>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- 統計情報 -->
  <div class="mt-4">
    <div class="row">
      <div class="col-md-4">
        <div class="card bg-light">
          <div class="card-body text-center">
            <h6 class="card-title">総代理店数</h6>
            <div class="fs-4 fw-bold text-primary"><%= agencies.length %></div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-light">
          <div class="card-body text-center">
            <h6 class="card-title">グループ所属済み</h6>
            <div class="fs-4 fw-bold text-success">
              <%= agencies.filter(a => a.group_name).length %>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-light">
          <div class="card-body text-center">
            <h6 class="card-title">グループ未所属</h6>
            <div class="fs-4 fw-bold text-warning">
              <%= agencies.filter(a => !a.group_name).length %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% } %>

  <!-- 注意事項 -->
  <div class="mt-4">
    <div class="alert alert-warning">
      <h6 class="alert-heading">
        <i class="bi bi-exclamation-triangle"></i> 代理店削除に関する注意
      </h6>
      <ul class="mb-0">
        <li><strong>関連データの削除:</strong> 代理店を削除すると、売上データ、商品資料、グループ所属情報、取り扱い商品情報もすべて削除されます。</li>
        <li><strong>ユーザーアカウント:</strong> 代理店ユーザーアカウントとの紐付けも解除されますが、アカウント自体は削除されません。</li>
        <li><strong>復元不可:</strong> 一度削除した代理店データは復元できません。慎重に操作してください。</li>
      </ul>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // URLパラメータから成功・エラーメッセージを表示
  const urlParams = new URLSearchParams(window.location.search);
  const successMsg = urlParams.get("success");
  const errorMsg = urlParams.get("error");

  if (successMsg) {
    const alertDiv = document.createElement("div");
    alertDiv.className = "alert alert-success alert-dismissible fade show";
    alertDiv.innerHTML = `
      <i class="bi bi-check-circle"></i> ${decodeURIComponent(successMsg)}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document
      .querySelector(".card")
      .insertBefore(alertDiv, document.querySelector(".d-flex"));
  }

  if (errorMsg) {
    const alertDiv = document.createElement("div");
    alertDiv.className = "alert alert-danger alert-dismissible fade show";
    alertDiv.innerHTML = `
      <i class="bi bi-exclamation-triangle"></i> ${decodeURIComponent(errorMsg)}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document
      .querySelector(".card")
      .insertBefore(alertDiv, document.querySelector(".d-flex"));
  }
</script> 