<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>代理店一覧 - 代理店管理システム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body class="container py-5">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">代理店管理システム</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <% if (typeof session !== 'undefined' && session && session.user &&
            session.user.role === 'admin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/agencies/list">代理店一覧</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups/list">グループ管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/api/users/list">アカウント管理</a>
            </li>
            <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && session.user.role === 'agency') { %>
            <li class="nav-item">
              <a class="nav-link text-warning" href="/auth/promote"
                >管理者・役員に切り替え</a
              >
            </li>
            <% if (session.user.agency_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/agencies/profile/<%= session.user.agency_id %>"
                >マイプロフィール</a
              >
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <% if (session.user.agency_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/materials/<%= session.user.agency_id %>"
                >商品資料格納庫</a
              >
            </li>
            <% } %> <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && (session.user.role === 'admin')) { %> <% } %> <% if
            (typeof session !== 'undefined' && session && session.user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">ログアウト</a>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/login">ログイン</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

<div class="card shadow-sm p-4 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">代理店一覧</h1>
    <div>
      <button type="button" class="btn btn-outline-info me-2" onclick="testRegistrationEmail()">
        <i class="bi bi-envelope-check"></i> 登録通知テスト
      </button>
      <a href="/agencies/new" class="btn btn-success">
        <i class="bi bi-person-plus"></i> 新規登録
      </a>
    </div>
  </div>

  <!-- 成功・エラーメッセージ -->
  <% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success alert-dismissible fade show">
    <i class="bi bi-check-circle"></i> <%= success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %>
  <% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle"></i> <%= error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %>

  <!-- 自動修正メッセージ -->
  <% if (typeof autoFixMessage !== 'undefined' && autoFixMessage) { %>
  <div class="alert alert-info alert-dismissible fade show">
    <i class="bi bi-info-circle"></i> <%= autoFixMessage %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %>

  <!-- ID整合性状況表示 -->
  <% if (integrityInfo && integrityInfo.isIntegrityOk) { %>
  <div class="alert alert-success alert-dismissible fade show">
    <i class="bi bi-check-circle"></i> 代理店IDの連番は正常です
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } else if (integrityInfo && integrityInfo.issues && integrityInfo.issues.length > 0) { %>
  <div class="alert alert-warning alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle"></i> 
    代理店IDの連番に問題があります（<%= integrityInfo.issues.length %>件）。
    ページ読み込み時に自動修正を試行します。
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %>
  
  <!-- グループフィルタリング -->
  <div class="mb-3">
    <form method="get" class="row g-2 align-items-center">
      <div class="col-auto">
        <label class="form-label">グループで絞り込み:</label>
      </div>
      <div class="col-auto">
        <select name="group_id" class="form-select">
          <option value="">すべて</option>
          <% groups.forEach(g => { %>
          <option value="<%= g.id %>" <%= selectedGroupId == g.id ? 'selected' : '' %>>
            <%= g.name %>
          </option>
          <% }) %>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">絞り込み</button>
      </div>
      <div class="col-auto">
        <a href="/groups/list" class="btn btn-outline-info">
          <i class="bi bi-collection"></i> グループ管理
        </a>
      </div>
    </form>
  </div>

  <!-- 代理店名検索 -->
  <div class="mb-3">
    <form method="get" class="row g-2 align-items-center">
      <div class="col-auto">
        <label class="form-label">代理店・商品検索:</label>
      </div>
      <div class="col-auto">
        <input type="text" name="search" class="form-control" placeholder="代理店名、商品名、住所など..." value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-search"></i> 検索
        </button>
      </div>
      <% if (typeof searchQuery !== 'undefined' && searchQuery) { %>
      <div class="col-auto">
        <a href="/agencies/list" class="btn btn-outline-secondary">
          <i class="bi bi-x-circle"></i> 検索解除
        </a>
      </div>
      <% } %>
      <!-- 既存のグループフィルタを保持 -->
      <% if (selectedGroupId) { %>
      <input type="hidden" name="group_id" value="<%= selectedGroupId %>">
      <% } %>
    </form>
  </div>
  
  <!-- 代理店が存在しない場合の表示 -->
  <% if (agencies.length === 0) { %>
  <div class="text-center py-5">
    <i class="bi bi-building fs-1 text-muted"></i>
    <h5 class="mt-3 text-muted">代理店がありません</h5>
    <p class="text-muted">最初の代理店を登録してください。</p>
    <a href="/agencies/new" class="btn btn-primary">
      <i class="bi bi-person-plus"></i> 代理店を登録
    </a>
  </div>
  <% } else { %>

  <!-- 横スクロール対応のテーブル -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>名前</th>
          <th>年齢</th>
          <th>住所</th>
          <th>振込先情報</th>
          <th>経験年数</th>
          <th>契約日</th>
          <th>活動開始日</th>
          <th>取り扱い商品</th>
          <th>グループ</th>
          <th>商品資料格納庫</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% agencies.forEach(a => { %>
        <tr>
          <td><%= a.id %></td>
          <td>
            <a href="/agencies/profile/<%= a.id %>" class="text-decoration-none fw-bold">
              <i class="bi bi-person-circle text-primary me-1"></i>
              <%= a.name %>
            </a>
          </td>
          <td><%= a.age || '未設定' %></td>
          <td><%= a.address || '未設定' %></td>
          <td><%= a.bank_info || '未設定' %></td>
          <td><%= a.experience_years || '未設定' %>年</td>
          <td><%= a.contract_date || '未設定' %></td>
          <td><%= a.start_date || '未設定' %></td>
          <td>
            <% if (a.product_count > 0) { %>
              <div class="d-flex flex-column">
                <span class="badge bg-primary mb-1"><%= a.product_count %>件</span>
                <% if (a.product_names) { %>
                  <small class="text-muted" style="font-size: 0.75rem;">
                    <% 
                      const maxLength = 30;
                      let displayNames = a.product_names;
                      if (displayNames.length > maxLength) {
                        displayNames = displayNames.substring(0, maxLength) + '...';
                      }
                    %>
                    <%= displayNames %>
                  </small>
                <% } %>
              </div>
            <% } else { %>
              <span class="text-muted">未設定</span>
            <% } %>
          </td>
          <td>
            <% if (a.group_name) { %>
              <span class="badge bg-info"><%= a.group_name %></span>
            <% } else { %>
              <span class="text-muted">未設定</span>
            <% } %>
          </td>
          <td>
            <a href="/materials/<%= a.id %>" class="btn btn-sm btn-success">
              <i class="bi bi-folder"></i> 資料を見る
            </a>
          </td>
          <td>
            <div class="btn-group-vertical" role="group">
              <a href="/agencies/profile/<%= a.id %>" class="btn btn-sm btn-outline-info mb-1">
                <i class="bi bi-eye"></i> 詳細
              </a>
              <a href="/agencies/edit/<%= a.id %>" class="btn btn-sm btn-outline-primary mb-1">
                <i class="bi bi-pencil"></i> 編集
              </a>
              <form 
                method="post" 
                action="/agencies/delete/<%= a.id %>" 
                style="display: inline"
                onsubmit="return confirm('「<%= a.name %>」の代理店データを削除しますか？\n\n注意: 以下のデータもすべて削除されます：\n• 売上データ\n• 商品資料\n• グループ所属情報\n• 取り扱い商品情報\n• 関連ユーザーアカウントとの紐付け\n\n削除後、代理店IDの整合性をチェックして自動的にIDを修正します。\n\nこの操作は取り消せません。')"
              >
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash"></i> 削除
                </button>
              </form>
            </div>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- 統計情報 -->
  <div class="mt-4">
    <div class="row">
      <div class="col-md-4">
        <div class="card bg-light">
          <div class="card-body text-center">
            <h6 class="card-title">総代理店数</h6>
            <div class="fs-4 fw-bold text-primary"><%= agencies.length %></div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-light">
          <div class="card-body text-center">
            <h6 class="card-title">グループ所属済み</h6>
            <div class="fs-4 fw-bold text-success">
              <%= agencies.filter(a => a.group_name).length %>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-light">
          <div class="card-body text-center">
            <h6 class="card-title">グループ未所属</h6>
            <div class="fs-4 fw-bold text-warning">
              <%= agencies.filter(a => !a.group_name).length %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% } %>

  <!-- 注意事項 -->
  <div class="mt-4">
    <div class="alert alert-warning">
      <h6 class="alert-heading">
        <i class="bi bi-exclamation-triangle"></i> 代理店削除に関する注意
      </h6>
      <ul class="mb-0">
        <li><strong>関連データの削除:</strong> 代理店を削除すると、売上データ、商品資料、グループ所属情報、取り扱い商品情報もすべて削除されます。</li>
        <li><strong>ユーザーアカウント:</strong> 代理店に関連するユーザーアカウントも完全に削除されます。</li>
        <li><strong>自動ID管理:</strong> 画面表示時と削除後にIDの連番をチェックし、問題があれば自動的に修正されます。</li>
        <li><strong>データ整合性:</strong> 削除操作により生じるIDの欠番は自動的に修正され、連番が維持されます。</li>
      </ul>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 登録通知テストメール送信
function testRegistrationEmail() {
  const button = event.target;
  const originalText = button.innerHTML;
  
  // ボタンを無効化
  button.disabled = true;
  button.innerHTML = '<i class="bi bi-hourglass-split"></i> 送信中...';
  
  fetch('/agencies/test-registration-email', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    // ボタンを復元
    button.disabled = false;
    button.innerHTML = originalText;
    
    if (data.success) {
      showAlert('success', `
        <strong>テストメール送信成功</strong><br>
        ${data.message}
      `);
    } else {
      showAlert('danger', `
        <strong>テストメール送信失敗</strong><br>
        ${data.message}
      `);
    }
  })
  .catch(error => {
    // ボタンを復元
    button.disabled = false;
    button.innerHTML = originalText;
    
    console.error('Error:', error);
    showAlert('danger', `
      <strong>エラーが発生しました</strong><br>
      ネットワークエラーまたはサーバーエラーです。
    `);
  });
}

// アラート表示機能
function showAlert(type, message) {
  // 既存のアラートを削除
  const existingAlerts = document.querySelectorAll('.alert-test');
  existingAlerts.forEach(alert => alert.remove());
  
  // 新しいアラートを作成
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-test`;
  alertDiv.innerHTML = `
    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  // ページの先頭に挿入
  const container = document.querySelector('.container');
  const firstChild = container.firstElementChild;
  container.insertBefore(alertDiv, firstChild);
  
  // 5秒後に自動で消去
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.remove();
    }
  }, 5000);
}
</script>
  </body>
</html> 