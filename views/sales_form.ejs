<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>売上<%= sale ? '編集' : '登録' %> - 代理店管理システム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body class="container py-5">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">代理店管理システム</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <% if (typeof session !== 'undefined' && session && session.user &&
            session.user.role === 'admin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/agencies/list">代理店一覧</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups/list">グループ管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/api/users/list">アカウント管理</a>
            </li>
            <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && session.user.role === 'agency') { %>
            <li class="nav-item">
              <a class="nav-link text-warning" href="/auth/promote"
                >管理者・役員に切り替え</a
              >
            </li>
            <% if (session.user.agency_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/agencies/profile/<%= session.user.agency_id %>"
                >マイプロフィール</a
              >
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <% if (session.user.agency_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/materials/<%= session.user.agency_id %>"
                >商品資料格納庫</a
              >
            </li>
            <% } %> <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && (session.user.role === 'admin')) { %> <% } %> <% if
            (typeof session !== 'undefined' && session && session.user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">ログアウト</a>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/login">ログイン</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

<div class="card shadow-sm p-4 mb-4">
  <h2 class="mb-4"><%= title %></h2>
  
  <% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-danger">
    <%= error %>
  </div>
  <% } %>
  
  <!-- 代理店ユーザーでagency_idが未設定の場合の案内 -->
  <% if (session.user.role === 'agency' && !session.user.agency_id) { %>
  <div class="alert alert-warning">
    <h5><i class="bi bi-exclamation-triangle"></i> プロフィール設定が必要です</h5>
    <p class="mb-3">売上管理を利用するには、まず代理店プロフィールを作成してください。</p>
    <a href="/agencies/create-profile" class="btn btn-primary">
      <i class="bi bi-person-plus"></i> プロフィールを作成
    </a>
    <a href="/" class="btn btn-secondary ms-2">ダッシュボードへ戻る</a>
  </div>
  <% } else { %>
  
  <form method="post" action="<%= typeof sale !== 'undefined' && sale ? '/sales/edit/' + sale.id : '/sales/new' %>">
    <% if (session.user.role !== 'agency') { %>
    <div class="mb-3">
      <label class="form-label">代理店 <span class="text-danger">*</span></label>
      <% if (typeof preselectedAgencyName !== 'undefined' && preselectedAgencyName) { %>
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong><%= preselectedAgencyName %></strong> が選択されています
      </div>
      <% } %>
      <select name="agency_id" class="form-select" required>
        <option value="">代理店を選択してください</option>
        <% agencies.forEach(a => { %>
        <option value="<%= a.id %>" <%= 
          (typeof sale !== 'undefined' && sale && sale.agency_id === a.id) ? 'selected' : 
          (typeof preselectedAgencyId !== 'undefined' && preselectedAgencyId == a.id) ? 'selected' : ''
        %>>
          <%= a.name %> (ID: <%= a.id %>)
        </option>
        <% }) %>
      </select>
    </div>
    <% } else { %>
    <div class="mb-3">
      <label class="form-label">代理店</label>
      <input type="text" class="form-control" value="<%= agencyName %>" readonly>
      <input type="hidden" name="agency_id" value="<%= session.user.agency_id %>">
    </div>
    <% } %>
    
    <div class="mb-3">
      <label class="form-label">年 <span class="text-danger">*</span></label>
      <input 
        type="number" 
        name="year" 
        class="form-control" 
        min="2020" 
        max="2030"
        value="<%= typeof sale !== 'undefined' && sale ? sale.year : new Date().getFullYear() %>"
        required 
      />
    </div>
    
    <div class="mb-3">
      <label class="form-label">月 <span class="text-danger">*</span></label>
      <select name="month" class="form-select" required>
        <option value="">月を選択してください</option>
        <% for (let i = 1; i <= 12; i++) { %>
        <option value="<%= i %>" <%= (typeof sale !== 'undefined' && sale && sale.month === i) ? 'selected' : '' %>>
          <%= i %>月
        </option>
        <% } %>
      </select>
    </div>
    
    <div class="mb-3">
      <label class="form-label">売上金額 <span class="text-danger">*</span></label>
      <div class="input-group">
        <span class="input-group-text">¥</span>
        <input 
          type="number" 
          name="amount" 
          class="form-control" 
          min="0"
          step="1000"
          value="<%= typeof sale !== 'undefined' && sale ? sale.amount : '' %>"
          placeholder="0"
          required 
        />
      </div>
      <small class="form-text text-muted">1,000円単位で入力してください</small>
    </div>
    
    <% if (session.user.agency_id || session.user.role !== 'agency') { %>
    <button type="submit" class="btn btn-success">
      <%= typeof sale !== 'undefined' && sale ? '更新' : '登録' %>
    </button>
    <% } %>
    <a href="/sales/list" class="btn btn-secondary ms-2">一覧へ戻る</a>
  </form>
  
  <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
