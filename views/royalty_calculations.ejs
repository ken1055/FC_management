<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロイヤリティ計算結果 - FC店舗管理システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">FC店舗管理システム</a>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="/stores/list">店舗一覧</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/sales/list">売上管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/customers/list">顧客管理</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle active" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                ロイヤリティ管理
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                <li><a class="dropdown-item" href="/royalty/settings">設定管理</a></li>
                                <li><a class="dropdown-item active" href="/royalty/calculations">計算実行</a></li>
                                <li><a class="dropdown-item" href="/royalty/report">レポート</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/auth/logout">ログアウト</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-calculator"></i> ロイヤリティ計算結果</h2>
        <div>
          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#calculateModal">
            <i class="bi bi-play"></i> 月次計算実行
          </button>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkInvoiceModal">
            <i class="bi bi-file-pdf"></i> 一括請求書生成
          </button>
        </div>
      </div>

      <!-- 検索・フィルター -->
      <div class="card mb-4">
        <div class="card-body">
          <form method="GET" action="/royalty/calculations">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="year" class="form-label">年</label>
                <select class="form-select" id="year" name="year">
                  <% for(let y = new Date().getFullYear(); y >= 2020; y--) { %>
                    <option value="<%= y %>" <% if (currentYear == y) { %>selected<% } %>><%= y %>年</option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-3">
                <label for="month" class="form-label">月</label>
                <select class="form-select" id="month" name="month">
                  <% for(let m = 1; m <= 12; m++) { %>
                    <option value="<%= m %>" <% if (currentMonth == m) { %>selected<% } %>><%= m %>月</option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-4">
                <label for="store_search" class="form-label">店舗検索</label>
                <input type="text" class="form-control" id="store_search" name="store_search" 
                       value="<%= store_search || '' %>" placeholder="店舗名で検索">
              </div>
              <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-outline-primary d-block w-100">
                  <i class="bi bi-search"></i> 検索
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- 計算結果一覧 -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><%= currentYear %>年<%= currentMonth %>月のロイヤリティ計算結果</h5>
        </div>
        <div class="card-body">
          <% if (calculations && calculations.length > 0) { %>
            <!-- 合計情報 -->
            <div class="row mb-4">
              <div class="col-md-4">
                <div class="card bg-primary text-white">
                  <div class="card-body text-center">
                    <h5>対象店舗数</h5>
                    <h2><%= calculations.length %>店舗</h2>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-success text-white">
                  <div class="card-body text-center">
                    <h5>総売上</h5>
                    <h2>¥<%= calculations.reduce((sum, calc) => sum + calc.monthly_sales, 0).toLocaleString() %></h2>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-warning text-white">
                  <div class="card-body text-center">
                    <h5>総ロイヤリティ</h5>
                    <h2>¥<%= calculations.reduce((sum, calc) => sum + calc.royalty_amount, 0).toLocaleString() %></h2>
                  </div>
                </div>
              </div>
            </div>

            <!-- 詳細テーブル -->
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>店舗名</th>
                    <th>月次売上</th>
                    <th>ロイヤリティ率</th>
                    <th>ロイヤリティ額</th>
                    <th>計算日時</th>
                    <th>ステータス</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <% calculations.forEach(calc => { %>
                    <tr>
                      <td><%= calc.store_name %></td>
                      <td>¥<%= calc.monthly_sales.toLocaleString() %></td>
                      <td><%= calc.royalty_rate %>%</td>
                      <td class="fw-bold">¥<%= calc.royalty_amount.toLocaleString() %></td>
                      <td><%= new Date(calc.calculated_at).toLocaleString('ja-JP') %></td>
                      <td>
                        <% if (calc.status === 'calculated') { %>
                          <span class="badge bg-success">計算済み</span>
                        <% } else if (calc.status === 'invoiced') { %>
                          <span class="badge bg-primary">請求済み</span>
                        <% } else { %>
                          <span class="badge bg-secondary"><%= calc.status %></span>
                        <% } %>
                      </td>
                      <td>
                        <a href="/royalty/invoice/<%= calc.id %>/view" class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-file-pdf"></i> 請求書
                        </a>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-4">
              <i class="bi bi-calculator display-1 text-muted"></i>
              <h5 class="mt-3 text-muted">計算結果がありません</h5>
              <p class="text-muted"><%= currentYear %>年<%= currentMonth %>月の計算結果が見つかりません。</p>
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#calculateModal">
                <i class="bi bi-play"></i> 月次計算を実行
              </button>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 計算実行モーダル -->
<div class="modal fade" id="calculateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">月次ロイヤリティ計算</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="calculateForm" method="POST" action="/royalty/calculate">
          <div class="mb-3">
            <label for="calc_year" class="form-label">計算対象年</label>
            <select class="form-select" id="calc_year" name="year" required>
              <% for(let y = new Date().getFullYear(); y >= 2020; y--) { %>
                <option value="<%= y %>" <% if (currentYear == y) { %>selected<% } %>><%= y %>年</option>
              <% } %>
            </select>
          </div>
          <div class="mb-3">
            <label for="calc_month" class="form-label">計算対象月</label>
            <select class="form-select" id="calc_month" name="month" required>
              <% for(let m = 1; m <= 12; m++) { %>
                <option value="<%= m %>" <% if (currentMonth == m) { %>selected<% } %>><%= m %>月</option>
              <% } %>
            </select>
          </div>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            この操作により、指定された月の全店舗のロイヤリティが自動計算されます。
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="submit" form="calculateForm" class="btn btn-primary">
          <i class="bi bi-play"></i> 計算実行
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 一括請求書生成モーダル -->
<div class="modal fade" id="bulkInvoiceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">一括請求書生成</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="bulkInvoiceForm">
          <div class="mb-3">
            <label for="invoice_year" class="form-label">対象年</label>
            <select class="form-select" id="invoice_year" name="year" required>
              <% for(let y = new Date().getFullYear(); y >= 2020; y--) { %>
                <option value="<%= y %>" <% if (currentYear == y) { %>selected<% } %>><%= y %>年</option>
              <% } %>
            </select>
          </div>
          <div class="mb-3">
            <label for="invoice_month" class="form-label">対象月</label>
            <select class="form-select" id="invoice_month" name="month" required>
              <% for(let m = 1; m <= 12; m++) { %>
                <option value="<%= m %>" <% if (currentMonth == m) { %>selected<% } %>><%= m %>月</option>
              <% } %>
            </select>
          </div>
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            この操作により、指定された月の全店舗の請求書PDFが一括生成されます。
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" id="bulkInvoiceBtn" class="btn btn-primary">
          <i class="bi bi-file-pdf"></i> 一括生成
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ロイヤリティ計算フォームの処理
document.getElementById('calculateForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const year = formData.get('year');
  const month = formData.get('month');
  
  // ローディング表示
  const submitBtn = document.querySelector('button[form="calculateForm"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 計算中...';
  submitBtn.disabled = true;
  
  try {
    const response = await fetch('/royalty/calculate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ year: parseInt(year), month: parseInt(month) })
    });
    
    const result = await response.json();
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('calculateModal'));
    modal.hide();
    
    // 結果を表示
    showCalculationResult(result);
    
    // ページをリロードして最新のデータを表示
    setTimeout(() => {
      window.location.reload();
    }, 3000);
    
  } catch (error) {
    console.error('計算エラー:', error);
    alert('計算処理でエラーが発生しました: ' + error.message);
  } finally {
    // ボタンを元に戻す
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
});

// 計算結果を表示する関数
function showCalculationResult(result) {
  let alertClass = result.success ? 'alert-success' : 'alert-danger';
  let icon = result.success ? '✅' : '❌';
  const yearFromResult = result?.summary?.year;
  const monthFromResult = result?.summary?.month;
  const fallbackYear = document.getElementById('calc_year')?.value;
  const fallbackMonth = document.getElementById('calc_month')?.value;
  const periodYear = yearFromResult ?? fallbackYear;
  const periodMonth = monthFromResult ?? fallbackMonth;
  
  let detailsHtml = '';
  if (result.success && result.details && result.details.length > 0) {
    detailsHtml = '<div class="mt-3"><h6>計算詳細:</h6><ul class="list-unstyled">';
    result.details.forEach(detail => {
      if (detail.success) {
        detailsHtml += `<li class="text-success">
          <strong>${detail.store_name}</strong>: 
          売上¥${detail.sales.toLocaleString()} → 
          ロイヤリティ¥${detail.royalty_amount.toLocaleString()} (${detail.royalty_rate}%)
        </li>`;
      } else {
        detailsHtml += `<li class="text-danger">
          <strong>${detail.store_name}</strong>: エラー - ${detail.error}
        </li>`;
      }
    });
    detailsHtml += '</ul>';
    
    if (result.summary) {
      detailsHtml += `<div class="border-top pt-2 mt-2">
        <strong>合計:</strong> 
        売上¥${result.summary.total_sales.toLocaleString()} → 
        ロイヤリティ¥${result.summary.total_royalty.toLocaleString()}
      </div>`;
    }
    
    detailsHtml += '</div>';
  }
  
  const alertHtml = `
    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
      <h5>${icon} ${periodYear}年${periodMonth}月: ${result.message}</h5>
      ${detailsHtml}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
  
  // アラートを表示
  const container = document.querySelector('.container-fluid');
  const alertDiv = document.createElement('div');
  alertDiv.innerHTML = alertHtml;
  container.insertBefore(alertDiv.firstElementChild, container.firstElementChild);
  
  // 5秒後に自動で非表示
  setTimeout(() => {
    const alert = document.querySelector('.alert');
    if (alert) {
      alert.remove();
    }
  }, 8000);
}

// 一括請求書生成の処理
document.getElementById('bulkInvoiceBtn').addEventListener('click', async function() {
  const year = document.getElementById('invoice_year').value;
  const month = document.getElementById('invoice_month').value;
  
  if (!year || !month) {
    alert('年月を選択してください');
    return;
  }
  
  // 確認ダイアログ
  if (!confirm(`${year}年${month}月の全店舗の請求書を一括生成しますか？`)) {
    return;
  }
  
  // ローディング表示
  const btn = this;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...';
  btn.disabled = true;
  
  try {
    const response = await fetch('/royalty/invoices/bulk', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ year: parseInt(year), month: parseInt(month) })
    });
    
    const result = await response.json();
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('bulkInvoiceModal'));
    modal.hide();
    
    // 結果を表示
    showBulkInvoiceResult(result);
    
    // ページをリロードして最新のデータを表示
    if (result.success) {
      setTimeout(() => {
        window.location.reload();
      }, 3000);
    }
    
  } catch (error) {
    console.error('一括請求書生成エラー:', error);
    alert('一括請求書生成でエラーが発生しました: ' + error.message);
  } finally {
    // ボタンを元に戻す
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
});

// 一括請求書生成結果を表示する関数
function showBulkInvoiceResult(result) {
  const alertClass = result.success ? 'alert-success' : 'alert-danger';
  const icon = result.success ? '✅' : '❌';
  
  const alertHtml = `
    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
      <h5>${icon} ${result.message}</h5>
      <p class="mb-0">
        成功: ${result.generated || 0}件 / エラー: ${result.errors || 0}件
      </p>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
  
  // アラートを表示
  const container = document.querySelector('.container');
  const alertDiv = document.createElement('div');
  alertDiv.innerHTML = alertHtml;
  container.insertBefore(alertDiv.firstElementChild, container.firstElementChild);
  
  // 5秒後に自動で非表示
  setTimeout(() => {
    const alert = document.querySelector('.alert');
    if (alert) {
      alert.remove();
    }
  }, 5000);
}
</script>
</body>
</html>
