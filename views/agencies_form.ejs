<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>
      代理店<%= agency ? '編集' : '新規登録' %> - 代理店管理システム
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body class="container py-5">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">代理店管理システム</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <% if (typeof session !== 'undefined' && session && session.user &&
            session.user.role === 'admin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/agencies/list">代理店一覧</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups/list">グループ管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/api/users/list">アカウント管理</a>
            </li>
            <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && session.user.role === 'agency') { %>
            <li class="nav-item">
              <a class="nav-link text-warning" href="/auth/promote"
                >管理者・役員に切り替え</a
              >
            </li>
            <% if (session.user.agency_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/agencies/profile/<%= session.user.agency_id %>"
                >マイプロフィール</a
              >
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <% if (session.user.agency_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/materials/<%= session.user.agency_id %>"
                >商品資料格納庫</a
              >
            </li>
            <% } %> <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && (session.user.role === 'admin')) { %> <% } %> <% if
            (typeof session !== 'undefined' && session && session.user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">ログアウト</a>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/login">ログイン</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

    <div class="card shadow-sm p-4 mb-4">
      <h1 class="mb-4">代理店<%= agency ? '編集' : '新規登録' %></h1>
      <form
        method="post"
        action="<%= 
      typeof isCreateProfile !== 'undefined' && isCreateProfile ? '/agencies/create-profile' :
      typeof isProfile !== 'undefined' && isProfile ? '/agencies/profile/' + agency.id + '/edit' : 
      (agency ? '/agencies/edit/' + agency.id : '/agencies/new') 
    %>"
      >
        <div class="mb-3">
          <label class="form-label"
            >名前 <span class="text-danger">*</span></label
          >
          <input
            type="text"
            name="name"
            class="form-control"
            value="<%= agency ? agency.name : '' %>"
            required
          />
        </div>

        <% if (typeof session !== 'undefined' && session && session.user &&
        session.user.role === 'admin' && !agency) { %>
        <!-- 管理者による新規代理店作成時のみ表示 -->
        <div class="card border-info mb-3">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0">
              <i class="bi bi-person-circle"></i> アカウント情報
            </h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">
                メールアドレス <span class="text-danger">*</span>
              </label>
              <input
                type="email"
                name="email"
                class="form-control"
                placeholder="agency@example.com"
                required
              />
              <small class="form-text text-muted">
                代理店ユーザーのログイン用メールアドレス
              </small>
            </div>
            <div class="mb-3">
              <label class="form-label">
                パスワード <span class="text-danger">*</span>
              </label>
              <input
                type="password"
                name="password"
                class="form-control"
                placeholder="8文字以上のパスワード"
                minlength="8"
                required
              />
              <small class="form-text text-muted">
                代理店ユーザーのログイン用パスワード（8文字以上）
              </small>
            </div>
            <div class="mb-0">
              <label class="form-label">
                パスワード確認 <span class="text-danger">*</span>
              </label>
              <input
                type="password"
                name="password_confirm"
                class="form-control"
                placeholder="パスワードを再入力"
                minlength="8"
                required
              />
              <small class="form-text text-muted">
                確認のため同じパスワードを入力してください
              </small>
            </div>
          </div>
        </div>
        <% } %>
        <div class="mb-3">
          <label class="form-label">年齢（20歳以上、または選択入力）</label>
          <div class="row">
            <div class="col-md-6">
              <input
                type="number"
                name="age"
                class="form-control"
                min="20"
                placeholder="直接入力"
                value="<%= agency ? agency.age : '' %>"
              />
            </div>
            <div class="col-md-6">
              <select
                name="age_select"
                class="form-select"
                onchange="setAge(this.value)"
              >
                <option value="">選択してください</option>
                <option value="20">20歳</option>
                <option value="25">25歳</option>
                <option value="30">30歳</option>
                <option value="35">35歳</option>
                <option value="40">40歳</option>
                <option value="45">45歳</option>
                <option value="50">50歳</option>
                <option value="55">55歳</option>
                <option value="60">60歳</option>
                <option value="65">65歳</option>
              </select>
            </div>
          </div>
          <small class="form-text text-muted"
            >直接入力するか、選択肢から選んでください</small
          >
        </div>
        <div class="mb-3">
          <label class="form-label">住所</label>
          <input
            type="text"
            name="address"
            class="form-control"
            value="<%= agency ? agency.address : '' %>"
          />
        </div>
        <div class="mb-3">
          <label class="form-label">振込先情報</label>
          <textarea
            name="bank_info"
            class="form-control"
            rows="3"
            placeholder="銀行名、支店名、口座番号、口座名義など"
          >
<%= agency ? agency.bank_info : '' %></textarea
          >
        </div>
        <div class="mb-3">
          <label class="form-label">経験年数</label>
          <input
            type="number"
            name="experience_years"
            class="form-control"
            min="0"
            value="<%= agency ? agency.experience_years : '' %>"
          />
        </div>
        <div class="mb-3">
          <label class="form-label">契約日</label>
          <input
            type="date"
            name="contract_date"
            class="form-control"
            value="<%= agency ? agency.contract_date : '' %>"
          />
        </div>
        <div class="mb-3">
          <label class="form-label">活動開始日</label>
          <input
            type="date"
            name="start_date"
            class="form-control"
            value="<%= agency ? agency.start_date : '' %>"
          />
        </div>
        <div class="mb-3">
          <label class="form-label">取り扱い商品名（複数選択可）</label>
          <div class="row">
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="products"
                value="商品A" id="productA" <%= (agency && agency.product_names
                && agency.product_names.includes('商品A')) ? 'checked' : '' %>>
                <label class="form-check-label" for="productA">商品A</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="products"
                value="商品B" id="productB" <%= (agency && agency.product_names
                && agency.product_names.includes('商品B')) ? 'checked' : '' %>>
                <label class="form-check-label" for="productB">商品B</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="products"
                value="商品C" id="productC" <%= (agency && agency.product_names
                && agency.product_names.includes('商品C')) ? 'checked' : '' %>>
                <label class="form-check-label" for="productC">商品C</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="products"
                value="商品D" id="productD" <%= (agency && agency.product_names
                && agency.product_names.includes('商品D')) ? 'checked' : '' %>>
                <label class="form-check-label" for="productD">商品D</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="products"
                value="商品E" id="productE" <%= (agency && agency.product_names
                && agency.product_names.includes('商品E')) ? 'checked' : '' %>>
                <label class="form-check-label" for="productE">商品E</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="products"
                value="その他" id="productOther" <%= (agency &&
                agency.product_names && agency.product_names.includes('その他'))
                ? 'checked' : '' %>>
                <label class="form-check-label" for="productOther"
                  >その他</label
                >
              </div>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">商品の特徴</label>
          <textarea
            name="product_features"
            class="form-control"
            rows="4"
            placeholder="取り扱い商品の特徴や詳細を記載してください"
          >
<%= agency ? agency.product_features : '' %></textarea
          >
        </div>
        <button type="submit" class="btn btn-success">保存</button>
        <% if (typeof isCreateProfile !== 'undefined' && isCreateProfile) { %>
        <a href="/" class="btn btn-secondary ms-2">ダッシュボードへ戻る</a>
        <% } else if (typeof isProfile !== 'undefined' && isProfile) { %>
        <a
          href="/agencies/profile/<%= agency.id %>"
          class="btn btn-secondary ms-2"
          >プロフィールへ戻る</a
        >
        <% } else { %>
        <a href="/agencies/list" class="btn btn-secondary ms-2">一覧へ戻る</a>
        <% } %>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function setAge(value) {
        if (value) {
          document.querySelector('input[name="age"]').value = value;
        }
      }
    </script>
  </body>
</html>
