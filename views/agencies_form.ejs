<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>
      店舗<%= agency ? '編集' : '新規登録' %> - 店舗管理システム
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body class="container py-5">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">店舗管理システム</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <% if (typeof session !== 'undefined' && session && session.user &&
            session.user.role === 'admin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/stores/list">店舗一覧</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups/list">グループ管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users/list">アカウント管理</a>
            </li>
            <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && session.user.role === 'agency') { %>
            <li class="nav-item">
              <a class="nav-link text-warning" href="/auth/promote"
                >管理者・役員に切り替え</a
              >
            </li>
            <% if (session.user.store_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/stores/profile/<%= session.user.store_id %>"
                >マイプロフィール</a
              >
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <% } %> <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && (session.user.role === 'admin')) { %> <% } %> <% if
            (typeof session !== 'undefined' && session && session.user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">ログアウト</a>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/login">ログイン</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

    <div class="card shadow-sm p-4 mb-4">
      <h1 class="mb-4">店舗<%= agency ? '編集' : '新規登録' %></h1>
      <form
        method="post"
        action="<%= 
      typeof isCreateProfile !== 'undefined' && isCreateProfile ? '/stores/create-profile' :
      typeof isProfile !== 'undefined' && isProfile ? '/stores/profile/' + agency.id + '/edit' : 
      (agency ? '/stores/edit/' + agency.id : '/stores/new') 
    %>"
      >
        <!-- 店舗基本情報 -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-shop"></i> 店舗基本情報</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">店舗名 <span class="text-danger">*</span></label>
                  <input type="text" name="name" class="form-control" value="<%= agency ? agency.name : '' %>" required />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">店長氏名</label>
                  <input type="text" name="manager_name" class="form-control" value="<%= agency ? agency.manager_name : '' %>" />
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">営業所住所</label>
              <input type="text" name="business_address" class="form-control" value="<%= agency ? agency.business_address : '' %>" />
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">代表電話</label>
                  <input type="tel" name="main_phone" class="form-control" value="<%= agency ? agency.main_phone : '' %>" />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">携帯電話</label>
                  <input type="tel" name="mobile_phone" class="form-control" value="<%= agency ? agency.mobile_phone : '' %>" />
                </div>
              </div>
            </div>
            <div class="mb-0">
              <label class="form-label">代表メール</label>
              <input type="email" name="representative_email" class="form-control" value="<%= agency ? agency.representative_email : '' %>" />
            </div>
          </div>
        </div>

        <% if (typeof session !== 'undefined' && session && session.user &&
        session.user.role === 'admin' && !agency) { %>
        <!-- 管理者による新規店舗作成時のみ表示 -->
        <div class="card border-info mb-3">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0">
              <i class="bi bi-person-circle"></i> アカウント情報
            </h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">
                メールアドレス <span class="text-danger">*</span>
              </label>
              <input
                type="email"
                name="email"
                class="form-control"
                placeholder="agency@example.com"
                required
              />
              <small class="form-text text-muted">
                店舗ユーザーのログイン用メールアドレス
              </small>
            </div>
            <div class="mb-3">
              <label class="form-label">
                パスワード <span class="text-danger">*</span>
              </label>
              <input
                type="password"
                name="password"
                class="form-control"
                placeholder="8文字以上のパスワード"
                minlength="8"
                required
              />
              <small class="form-text text-muted">
                店舗ユーザーのログイン用パスワード（8文字以上）
              </small>
            </div>
            <div class="mb-0">
              <label class="form-label">
                パスワード確認 <span class="text-danger">*</span>
              </label>
              <input
                type="password"
                name="password_confirm"
                class="form-control"
                placeholder="パスワードを再入力"
                minlength="8"
                required
              />
              <small class="form-text text-muted">
                確認のため同じパスワードを入力してください
              </small>
            </div>
          </div>
        </div>
        <% } %>

        <!-- 契約基本情報 -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> 契約基本情報</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">契約形態</label>
                  <select name="contract_type" class="form-select">
                    <option value="">選択してください</option>
                    <option value="franchise" <%= agency && agency.contract_type === 'franchise' ? 'selected' : '' %>>フランチャイズ</option>
                    <option value="agency" <%= agency && agency.contract_type === 'agency' ? 'selected' : '' %>>代理店</option>
                    <option value="direct" <%= agency && agency.contract_type === 'direct' ? 'selected' : '' %>>直営</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">契約開始日</label>
                  <input type="date" name="contract_start_date" class="form-control" value="<%= agency ? agency.contract_start_date : '' %>" />
                </div>
              </div>
            </div>
            <div class="mb-0">
              <label class="form-label">ロイヤリティ率（%）</label>
              <input type="number" name="royalty_rate" class="form-control" step="0.01" min="0" max="100" value="<%= agency ? agency.royalty_rate : '5.0' %>" />
            </div>
          </div>
        </div>

        <!-- 請求基本情報 -->
        <div class="card mb-4">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-credit-card"></i> 請求基本情報</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">インボイス登録番号</label>
              <input type="text" name="invoice_number" class="form-control" placeholder="T0000000000000" value="<%= agency ? agency.invoice_number : '' %>" />
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">銀行名</label>
                  <input type="text" name="bank_name" class="form-control" value="<%= agency ? agency.bank_name : '' %>" />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">支店名</label>
                  <input type="text" name="branch_name" class="form-control" value="<%= agency ? agency.branch_name : '' %>" />
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">口座種別</label>
                  <select name="account_type" class="form-select">
                    <option value="">選択してください</option>
                    <option value="ordinary" <%= agency && agency.account_type === 'ordinary' ? 'selected' : '' %>>普通</option>
                    <option value="current" <%= agency && agency.account_type === 'current' ? 'selected' : '' %>>当座</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">口座番号</label>
                  <input type="text" name="account_number" class="form-control" value="<%= agency ? agency.account_number : '' %>" />
                </div>
              </div>
            </div>
            <div class="mb-0">
              <label class="form-label">口座名義</label>
              <input type="text" name="account_holder" class="form-control" value="<%= agency ? agency.account_holder : '' %>" />
            </div>
          </div>
        </div>

        <!-- 許認可情報 -->
        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-shield-check"></i> 許認可情報</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">許可有無</label>
              <select name="license_status" class="form-select">
                <option value="none" <%= agency && agency.license_status === 'none' ? 'selected' : '' %>>なし</option>
                <option value="have" <%= agency && agency.license_status === 'have' ? 'selected' : '' %>>あり</option>
              </select>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">許可種別</label>
                  <input type="text" name="license_type" class="form-control" value="<%= agency ? agency.license_type : '' %>" />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">許可番号</label>
                  <input type="text" name="license_number" class="form-control" value="<%= agency ? agency.license_number : '' %>" />
                </div>
              </div>
            </div>
            <div class="mb-0">
              <label class="form-label">許可証データ（ファイルパス/URL）</label>
              <input type="text" name="license_file_path" class="form-control" placeholder="https://example.com/license.pdf" value="<%= agency ? agency.license_file_path : '' %>" />
            </div>
          </div>
        </div>

        <!-- 連携ID -->
        <div class="card mb-4">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-link-45deg"></i> 連携ID</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">LINE公式アカウントID</label>
                  <input type="text" name="line_official_id" class="form-control" placeholder="@example" value="<%= agency ? agency.line_official_id : '' %>" />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-0">
                  <label class="form-label">代表Gmail</label>
                  <input type="email" name="representative_gmail" class="form-control" placeholder="example@gmail.com" value="<%= agency ? agency.representative_gmail : '' %>" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-success">保存</button>
        <% if (typeof isCreateProfile !== 'undefined' && isCreateProfile) { %>
        <a href="/" class="btn btn-secondary ms-2">ダッシュボードへ戻る</a>
        <% } else if (typeof isProfile !== 'undefined' && isProfile) { %>
        <a
          href="/stores/profile/<%= agency.id %>"
          class="btn btn-secondary ms-2"
          >プロフィールへ戻る</a
        >
        <% } else { %>
        <a href="/stores/list" class="btn btn-secondary ms-2">一覧へ戻る</a>
        <% } %>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
