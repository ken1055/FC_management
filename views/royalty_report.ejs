<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロイヤリティレポート - FC店舗管理システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">FC店舗管理システム</a>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="/stores/list">店舗一覧</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/sales/list">売上管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/customers/list">顧客管理</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle active" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                ロイヤリティ管理
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                <li><a class="dropdown-item" href="/royalty/settings">設定管理</a></li>
                                <li><a class="dropdown-item" href="/royalty/calculations">計算実行</a></li>
                                <li><a class="dropdown-item active" href="/royalty/report">レポート</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/auth/logout">ログアウト</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

    <div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-graph-up"></i> ロイヤリティレポート</h2>
        <div>
          <button class="btn btn-outline-primary" onclick="window.print()">
            <i class="bi bi-printer"></i> 印刷
          </button>
          <button class="btn btn-success" onclick="exportToCSV()">
            <i class="bi bi-file-excel"></i> CSV出力
          </button>
        </div>
      </div>

      <!-- 期間選択 -->
      <div class="card mb-4">
        <div class="card-body">
          <form method="GET" action="/royalty/report">
            <div class="row g-3">
              <div class="col-md-2">
                <label for="start_year" class="form-label">開始年</label>
                <select class="form-select" id="start_year" name="start_year">
                  <% for(let y = new Date().getFullYear(); y >= 2020; y--) { %>
                    <option value="<%= y %>" <% if (start_year == y) { %>selected<% } %>><%= y %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-2">
                <label for="start_month" class="form-label">開始月</label>
                <select class="form-select" id="start_month" name="start_month">
                  <% for(let m = 1; m <= 12; m++) { %>
                    <option value="<%= m %>" <% if (start_month == m) { %>selected<% } %>><%= m %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-2">
                <label for="end_year" class="form-label">終了年</label>
                <select class="form-select" id="end_year" name="end_year">
                  <% for(let y = new Date().getFullYear(); y >= 2020; y--) { %>
                    <option value="<%= y %>" <% if (end_year == y) { %>selected<% } %>><%= y %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-2">
                <label for="end_month" class="form-label">終了月</label>
                <select class="form-select" id="end_month" name="end_month">
                  <% for(let m = 1; m <= 12; m++) { %>
                    <option value="<%= m %>" <% if (end_month == m) { %>selected<% } %>><%= m %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary d-block w-100">
                  <i class="bi bi-search"></i> 表示
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- サマリー情報 -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <h5>期間</h5>
              <h6><%= start_year %>/<%= start_month %> - <%= end_year %>/<%= end_month %></h6>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h5>総売上</h5>
              <h4>¥<%= totalSales.toLocaleString() %></h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body text-center">
              <h5>総ロイヤリティ</h5>
              <h4>¥<%= totalRoyalty.toLocaleString() %></h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h5>平均ロイヤリティ率</h5>
              <h4><%= avgRoyaltyRate.toFixed(2) %>%</h4>
            </div>
          </div>
        </div>
      </div>

      <!-- 月別推移グラフ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">月別推移</h5>
        </div>
        <div class="card-body">
          <canvas id="monthlyChart" height="100"></canvas>
        </div>
      </div>

      <!-- 店舗別詳細 -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">店舗別詳細</h5>
        </div>
        <div class="card-body">
          <% if (detailData && detailData.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-striped" id="reportTable">
                <thead>
                  <tr>
                    <th>店舗名</th>
                    <th>月次売上</th>
                    <th>ロイヤリティ金額</th>
                    <th>ロイヤリティ率</th>
                    <th>計算月</th>
                    <th>計算日</th>
                  </tr>
                </thead>
                <tbody>
                  <% detailData.forEach(store => { %>
                    <tr>
                      <td><%= store.store_name %></td>
                      <td>¥<%= store.monthly_sales.toLocaleString() %></td>
                      <td>¥<%= store.royalty_amount.toLocaleString() %></td>
                      <td><%= store.royalty_rate.toFixed(2) %>%</td>
                      <td><%= store.calculation_month %>月</td>
                      <td><%= new Date(store.calculated_at).toLocaleDateString('ja-JP') %></td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-4">
              <i class="bi bi-graph-up display-1 text-muted"></i>
              <h5 class="mt-3 text-muted">データがありません</h5>
              <p class="text-muted">指定された期間のデータが見つかりません。</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 月別推移チャート
<% if (monthlyData && monthlyData.length > 0) { %>
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: [<% monthlyData.forEach((data, index) => { %>'<%= data.calculation_month %>月'<% if (index < monthlyData.length - 1) { %>,<% } %><% }); %>],
        datasets: [{
            label: '売上',
            data: [<% monthlyData.forEach((data, index) => { %><%= data.total_sales %><% if (index < monthlyData.length - 1) { %>,<% } %><% }); %>],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            yAxisID: 'y'
        }, {
            label: 'ロイヤリティ',
            data: [<% monthlyData.forEach((data, index) => { %><%= data.total_royalty %><% if (index < monthlyData.length - 1) { %>,<% } %><% }); %>],
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: '月'
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: '売上 (¥)'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'ロイヤリティ (¥)'
                },
                grid: {
                    drawOnChartArea: false,
                }
            }
        }
    }
});
<% } %>

// CSV出力機能
function exportToCSV() {
    const table = document.getElementById('reportTable');
    let csv = [];
    
    // ヘッダー行
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent.trim());
    });
    csv.push(headers.join(','));
    
    // データ行
    table.querySelectorAll('tbody tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => {
            row.push('"' + td.textContent.trim().replace(/"/g, '""') + '"');
        });
        csv.push(row.join(','));
    });
    
    // ファイルダウンロード
    const csvContent = csv.join('\n');
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'royalty_report_<%= start_year %>_<%= start_month %>_to_<%= end_year %>_<%= end_month %>.csv';
    link.click();
}
</script>

<style>
@media print {
    .btn, .card-header { 
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
}
</style>
</body>
</html>
