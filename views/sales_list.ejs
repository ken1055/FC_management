<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>売上管理 - 店舗管理システム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body class="container py-5">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">店舗管理システム</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <% if (typeof session !== 'undefined' && session && session.user &&
            session.user.role === 'admin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/stores/list">店舗一覧</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/history">売上履歴</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups/list">グループ管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users/list">アカウント管理</a>
            </li>
            <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && session.user.role === 'agency') { %>
            <li class="nav-item">
              <a class="nav-link text-warning" href="/auth/promote"
                >管理者・役員に切り替え</a
              >
            </li>
            <% if (session.user.store_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/stores/profile/<%= session.user.store_id %>"
                >マイプロフィール</a
              >
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/history">売上履歴</a>
            </li>
            <% if (session.user.store_id) { %>
            <% } %> <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && (session.user.role === 'admin')) { %> <% } %> <% if
            (typeof session !== 'undefined' && session && session.user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">ログアウト</a>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/login">ログイン</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

<div class="card shadow-sm p-4 mb-4">
  <% if (typeof window === 'undefined' && typeof location === 'undefined') { %>
  <% } %>
  <% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle"></i> 変更が保存されました。
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% } %>
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <% if (typeof isAdmin !== 'undefined' && isAdmin && agencyName) { %>
      <%= agencyName %> の売上管理
      <% } else { %>
      売上管理
      <% } %>
    </h2>
    <div>
      <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
        <% if (typeof showOverview !== 'undefined' && showOverview) { %>
          <a href="/sales/list?overview=false" class="btn btn-outline-primary me-2">
            <i class="bi bi-list"></i> 店舗別表示
          </a>
        <% } else { %>
          <a href="/sales/list" class="btn btn-outline-primary me-2">
            <i class="bi bi-graph-up"></i> 統合ビュー
          </a>
        <% } %>
        <% if (typeof agencyId === 'undefined') { %>
          <a href="/sales/list?overview=false" class="btn btn-secondary me-2">店舗選択</a>
        <% } else { %>
          <a href="/sales/list" class="btn btn-secondary me-2">統合ビューへ戻る</a>
        <% } %>
      <% } %>
      <% if (typeof agencyId !== 'undefined' && agencyId) { %>
      <a href="/sales/new?store_id=<%= agencyId %>" class="btn btn-success">売上登録</a>
      <% } else { %>
      <a href="/sales/new" class="btn btn-success">売上登録</a>
      <% } %>
    </div>
  </div>
  
  <% if (session.user.role === 'agency' && agencyName) { %>
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      <strong><%= agencyName %></strong> の売上データ
    </div>
  <% } %>
  
  <% if (typeof isAdmin !== 'undefined' && isAdmin && agencyName) { %>
    <div class="alert alert-primary">
      <i class="bi bi-building"></i>
      <strong><%= agencyName %></strong> の売上データを管理者として表示しています
    </div>
  <% } %>
  
  <!-- 月間売上推移グラフ -->
  <% if (chartData && JSON.parse(chartData).length > 0) { %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">月間売上推移</h5>
    </div>
    <div class="card-body">
      <canvas id="salesChart" width="400" height="200"></canvas>
    </div>
  </div>
  <% } %>
  
  <!-- グループフィルタリング（管理者のみ） -->
  <% if (session.user.role !== 'agency' && groups.length > 0) { %>
  <div class="mb-3">
    <form method="get" class="row g-2 align-items-center">
      <div class="col-auto">
        <label class="form-label">グループで絞り込み:</label>
      </div>
      <div class="col-auto">
        <select name="group_id" class="form-select">
          <option value="">すべて</option>
          <% groups.forEach(g => { %>
          <option value="<%= g.id %>" <%= selectedGroupId == g.id ? 'selected' : '' %>>
            <%= g.name %>
          </option>
          <% }) %>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">絞り込み</button>
      </div>
    </form>
  </div>
  <% } %>
  
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <% if (session.user.role !== 'agency') { %>
          <th>店舗名</th>
          <% } %>
          <th>年</th>
          <th>月</th>
          <th>金額</th>
          <th>取引件数</th>
          <th>平均単価</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% if (sales.length === 0) { %>
        <tr>
          <td colspan="<%= session.user.role === 'agency' ? '6' : '7' %>" class="text-center text-muted">
            <div class="py-4">
              <i class="bi bi-inbox display-4 text-muted d-block mb-3"></i>
              <h5 class="text-muted">売上データがありません</h5>
              <p class="text-muted">取引を登録すると、ここに月次集計が表示されます</p>
              <a href="/sales/new" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> 売上を登録
              </a>
            </div>
          </td>
        </tr>
        <% } else { %>
        <% sales.forEach(s => { %>
        <tr>
          <% if (session.user.role !== 'agency') { %>
          <td><%= s.agency_name || 'ID:' + s.store_id %></td>
          <% } %>
          <td><%= s.year %></td>
          <td><%= s.month %></td>
          <td class="fw-bold text-success">¥<%= (s.amount || 0).toLocaleString() %></td>
          <td>
            <span class="badge bg-info">
              <%= (s.transaction_count || 0).toLocaleString() %>件
            </span>
          </td>
          <td>
            ¥<%= s.transaction_count > 0 ? Math.round((s.amount || 0) / s.transaction_count).toLocaleString() : '0' %>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <a href="/sales/history?start_date=<%= s.year %>-<%= String(s.month).padStart(2, '0') %>-01&end_date=<%= s.year %>-<%= String(s.month).padStart(2, '0') %>-31" 
                 class="btn btn-outline-primary" title="詳細履歴">
                <i class="bi bi-list-ul"></i>
              </a>
              <a href="/sales/new" class="btn btn-outline-success" title="新規登録">
                <i class="bi bi-plus-circle"></i>
              </a>
            </div>
          </td>
        </tr>
        <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
  
  <% if (sales.length > 0) { %>
  <div class="mt-3">
    <div class="row">
      <div class="col-md-6">
        <div class="card bg-light">
          <div class="card-body">
            <h6 class="card-title">合計売上</h6>
            <h4 class="text-primary">¥<%= sales.reduce((sum, s) => sum + s.amount, 0).toLocaleString() %></h4>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card bg-light">
          <div class="card-body">
            <h6 class="card-title">平均売上</h6>
            <h4 class="text-success">¥<%= Math.round(sales.reduce((sum, s) => sum + s.amount, 0) / sales.length).toLocaleString() %></h4>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<% if (chartData && JSON.parse(chartData).length > 0) { %>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
  const chartData = <%- chartData %>;
  const ctx = document.getElementById('salesChart').getContext('2d');
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: chartData.map(d => d.period),
      datasets: [{
        label: '売上金額',
        data: chartData.map(d => d.amount),
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: '月間売上推移'
        },
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '¥' + value.toLocaleString();
            }
          }
        }
      }
    }
  });
</script>
<% } %>
  </body>
</html>
