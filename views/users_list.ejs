<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ユーザー管理 - 代理店管理システム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body class="container py-5">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">代理店管理システム</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <% if (typeof session !== 'undefined' && session && session.user &&
            session.user.role === 'admin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/agencies/list">代理店一覧</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups/list">グループ管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/api/users/list">アカウント管理</a>
            </li>
            <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && session.user.role === 'agency') { %>
            <li class="nav-item">
              <a class="nav-link text-warning" href="/auth/promote"
                >管理者・役員に切り替え</a
              >
            </li>
            <% if (session.user.agency_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/agencies/profile/<%= session.user.agency_id %>"
                >マイプロフィール</a
              >
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <% if (session.user.agency_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/materials/<%= session.user.agency_id %>"
                >商品資料格納庫</a
              >
            </li>
            <% } %> <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && (session.user.role === 'admin')) { %> <% } %> <% if
            (typeof session !== 'undefined' && session && session.user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">ログアウト</a>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/login">ログイン</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

    <div class="card shadow-sm p-4 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">管理者アカウント管理</h2>
        <div>
          <a href="/api/users/new" class="btn btn-success me-2">
            <i class="bi bi-person-plus"></i> 新規アカウント作成
          </a>
          <a href="/" class="btn btn-secondary">ダッシュボードへ戻る</a>
        </div>
      </div>

      <!-- 成功・エラーメッセージ -->
      <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle"></i> <%= success %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      <% } %> <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle"></i> <%= error %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      <% } %>

      <!-- 自動修正メッセージ -->
      <% if (typeof autoFixMessage !== 'undefined' && autoFixMessage) { %>
      <div class="alert alert-info alert-dismissible fade show">
        <i class="bi bi-info-circle"></i> <%= autoFixMessage %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      <% } %>

      <!-- ID整合性状況表示 -->
      <% if (integrityInfo && integrityInfo.isIntegrityOk) { %>
      <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle"></i> ユーザーIDの連番は正常です
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      <% } %>

      <!-- アカウント統計 -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h6 class="card-title">管理者アカウント</h6>
              <div class="fs-4 fw-bold"><%= admins.length %> / 5</div>
              <small>最大5つまで</small>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h6 class="card-title">合計</h6>
              <div class="fs-4 fw-bold"><%= users.length %></div>
              <small>管理者アカウント数</small>
            </div>
          </div>
        </div>
      </div>

      <!-- アカウント一覧 -->
      <% if (users.length === 0) { %>
      <div class="text-center py-5">
        <i class="bi bi-people fs-1 text-muted"></i>
        <h5 class="mt-3 text-muted">管理者アカウントがありません</h5>
        <p class="text-muted">最初の管理者アカウントを作成してください。</p>
        <a href="/api/users/new" class="btn btn-primary">
          <i class="bi bi-person-plus"></i> アカウントを作成
        </a>
      </div>
      <% } else { %>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>メールアドレス</th>
              <th>権限</th>
              <th>状態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% users.forEach(user => { %>
            <tr>
              <td>
                <span class="badge bg-primary">#<%= user.id %></span>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <i class="bi bi-shield-check text-success me-2"></i>
                  <%= user.email %>
                </div>
              </td>
              <td>
                <span class="badge bg-success">
                  <i class="bi bi-shield-check"></i> 管理者
                </span>
              </td>
              <td>
                <% if (session.user.id == user.id) { %>
                <span class="badge bg-primary">
                  <i class="bi bi-person-check"></i> 現在のログインユーザー
                </span>
                <% } else { %>
                <span class="badge bg-secondary">
                  <i class="bi bi-circle-fill"></i> アクティブ
                </span>
                <% } %>
              </td>
              <td>
                <% if (session.user.id == user.id) { %>
                <span class="text-muted small">
                  <i class="bi bi-info-circle"></i> 自分自身は削除できません
                </span>
                <% } else { %>
                <form
                  method="post"
                  action="/api/users/delete/<%= user.id %>"
                  style="display: inline"
                  onsubmit="return confirm('「<%= user.email %>」のアカウントを削除しますか？\n\n削除後、ID整合性をチェックして自動的にIDを修正します。\n\nこの操作は取り消せません。')"
                >
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-trash"></i> 削除
                  </button>
                </form>
                <% } %>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- 注意事項 -->
      <div class="mt-4">
        <div class="alert alert-info">
          <h6 class="alert-heading">
            <i class="bi bi-info-circle"></i> アカウント管理について
          </h6>
          <ul class="mb-0">
            <li>
              <strong>管理者アカウント:</strong>
              代理店管理、売上管理、システム全体へのアクセス権限。最大5つまで作成可能。
            </li>
            <li>
              <strong>削除制限:</strong>
              現在ログイン中のアカウントは削除できません。
            </li>
            <li>
              <strong>自動ID管理:</strong>
              画面表示時にIDの連番をチェックし、問題があれば自動的に修正されます。
            </li>
            <li>
              <strong>パスワード:</strong>
              本番環境では必ずハッシュ化を実装してください。
            </li>
          </ul>
        </div>
      </div>

      <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
