<% layout('layout', { title: title, session: session }) %>
<div class="card shadow-sm p-4 mb-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">役員・管理者アカウント管理</h2>
    <div>
      <a href="/api/users/new" class="btn btn-success me-2">
        <i class="bi bi-person-plus"></i> 新規アカウント作成
      </a>
      <a href="/" class="btn btn-secondary">ダッシュボードへ戻る</a>
    </div>
  </div>

  <!-- 成功・エラーメッセージ -->
  <% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success alert-dismissible fade show">
    <i class="bi bi-check-circle"></i> <%= success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %> <% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle"></i> <%= error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %>

  <!-- アカウント統計 -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <h6 class="card-title">役員アカウント</h6>
          <div class="fs-4 fw-bold"><%= executives.length %> / 1</div>
          <small>最大1つまで</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <h6 class="card-title">管理者アカウント</h6>
          <div class="fs-4 fw-bold"><%= admins.length %> / 4</div>
          <small>最大4つまで</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <h6 class="card-title">合計</h6>
          <div class="fs-4 fw-bold"><%= users.length %></div>
          <small>役員・管理者アカウント</small>
        </div>
      </div>
    </div>
  </div>

  <!-- アカウント一覧 -->
  <% if (users.length === 0) { %>
  <div class="text-center py-5">
    <i class="bi bi-people fs-1 text-muted"></i>
    <h5 class="mt-3 text-muted">アカウントがありません</h5>
    <p class="text-muted">最初のアカウントを作成してください。</p>
    <a href="/api/users/new" class="btn btn-primary">
      <i class="bi bi-person-plus"></i> アカウントを作成
    </a>
  </div>
  <% } else { %>

  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>メールアドレス</th>
          <th>権限</th>
          <th>状態</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(user => { %>
        <tr>
          <td><%= user.id %></td>
          <td>
            <div class="d-flex align-items-center">
              <% if (user.role === 'executive') { %>
              <i class="bi bi-star-fill text-warning me-2"></i>
              <% } else { %>
              <i class="bi bi-shield-check text-success me-2"></i>
              <% } %> <%= user.email %>
            </div>
          </td>
          <td>
            <% if (user.role === 'executive') { %>
            <span class="badge bg-warning text-dark">
              <i class="bi bi-star-fill"></i> 役員
            </span>
            <% } else if (user.role === 'admin') { %>
            <span class="badge bg-success">
              <i class="bi bi-shield-check"></i> 管理者
            </span>
            <% } %>
          </td>
          <td>
            <% if (session.user.id == user.id) { %>
            <span class="badge bg-primary">
              <i class="bi bi-person-check"></i> 現在のログインユーザー
            </span>
            <% } else { %>
            <span class="badge bg-secondary">
              <i class="bi bi-circle-fill"></i> アクティブ
            </span>
            <% } %>
          </td>
          <td>
            <% if (session.user.id == user.id) { %>
            <span class="text-muted small">
              <i class="bi bi-info-circle"></i> 自分自身は削除できません
            </span>
            <% } else { %>
            <form
              method="post"
              action="/api/users/delete/<%= user.id %>"
              style="display: inline"
              onsubmit="return confirm('「<%= user.email %>」のアカウントを削除しますか？\n\nこの操作は取り消せません。')"
            >
              <button type="submit" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-trash"></i> 削除
              </button>
            </form>
            <% } %>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- 注意事項 -->
  <div class="mt-4">
    <div class="alert alert-info">
      <h6 class="alert-heading">
        <i class="bi bi-info-circle"></i> アカウント管理について
      </h6>
      <ul class="mb-0">
        <li>
          <strong>役員アカウント:</strong>
          システム全体の最高権限。1つまで作成可能。
        </li>
        <li>
          <strong>管理者アカウント:</strong>
          代理店管理、売上管理等の機能を利用可能。4つまで作成可能。
        </li>
        <li>
          <strong>削除制限:</strong>
          現在ログイン中のアカウントは削除できません。
        </li>
        <li>
          <strong>パスワード:</strong>
          本番環境では必ずハッシュ化を実装してください。
        </li>
      </ul>
    </div>
  </div>

  <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // URLパラメータから成功・エラーメッセージを表示
  const urlParams = new URLSearchParams(window.location.search);
  const successMsg = urlParams.get("success");
  const errorMsg = urlParams.get("error");

  if (successMsg) {
    const alertDiv = document.createElement("div");
    alertDiv.className = "alert alert-success alert-dismissible fade show";
    alertDiv.innerHTML = `
      <i class="bi bi-check-circle"></i> ${decodeURIComponent(successMsg)}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document
      .querySelector(".card")
      .insertBefore(alertDiv, document.querySelector(".d-flex"));
  }

  if (errorMsg) {
    const alertDiv = document.createElement("div");
    alertDiv.className = "alert alert-danger alert-dismissible fade show";
    alertDiv.innerHTML = `
      <i class="bi bi-exclamation-triangle"></i> ${decodeURIComponent(errorMsg)}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document
      .querySelector(".card")
      .insertBefore(alertDiv, document.querySelector(".d-flex"));
  }
</script>
