<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>代理店ダッシュボード - 代理店管理システム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
        <div class="container-fluid">
          <a class="navbar-brand" href="/">代理店管理システム</a>
          <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <% if (session && session.user && session.user.agency_id) { %>
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="/agencies/profile/<%= session.user.agency_id %>"
                  >マイプロフィール</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/sales/list">売上管理</a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  href="/materials/<%= session.user.agency_id %>"
                  >商品資料格納庫</a
                >
              </li>
              <% } %>
              <li class="nav-item">
                <a class="nav-link text-warning" href="/auth/promote"
                  >管理者・役員に切り替え</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/auth/logout">ログアウト</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <div class="row">
        <div class="col-md-12">
          <div class="card shadow-sm p-4 mb-4">
            <h1 class="mb-3">代理店管理システム</h1>
            <p class="mb-4">代理店管理システムへようこそ。</p>

            <!-- 代理店ユーザー向けメニュー -->
            <% if (session && session.user && session.user.role === 'agency') {
            %>
            <div class="mb-3">
              <h5>代理店機能</h5>
              <% if (session.user.agency_id) { %>
              <div class="row g-3">
                <div class="col-lg-3 col-md-6">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <i class="bi bi-person-circle fs-1 text-primary"></i>
                      <h6 class="card-title mt-2">マイプロフィール</h6>
                      <p class="card-text text-muted">
                        個人情報や取り扱い商品を管理
                      </p>
                      <a
                        href="/agencies/profile/<%= session.user.agency_id %>"
                        class="btn btn-outline-primary"
                      >
                        プロフィール表示
                      </a>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <i class="bi bi-graph-up fs-1 text-success"></i>
                      <h6 class="card-title mt-2">売上管理</h6>
                      <p class="card-text text-muted">月間売上の入力・確認</p>
                      <a href="/sales/list" class="btn btn-outline-success"
                        >売上管理</a
                      >
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <i class="bi bi-folder-fill fs-1 text-info"></i>
                      <h6 class="card-title mt-2">商品資料格納庫</h6>
                      <p class="card-text text-muted">
                        商品資料の閲覧・ダウンロード
                      </p>
                      <a
                        href="/materials/<%= session.user.agency_id %>"
                        class="btn btn-outline-info"
                      >
                        資料を見る
                      </a>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6">
                  <div
                    class="card h-100"
                    id="admin-url-card-standalone"
                    style="display: none"
                  >
                    <div class="card-body text-center">
                      <i
                        class="bi bi-arrow-up-right-square fs-1 text-primary"
                      ></i>
                      <h6 class="card-title mt-2">指定ページ</h6>
                      <p class="card-text text-muted">
                        管理者が設定したページへ
                      </p>
                      <a
                        href="#"
                        id="admin-url-link-standalone"
                        target="_blank"
                        class="btn btn-primary"
                      >
                        <i class="bi bi-arrow-up-right-square"></i> ページを開く
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <% } else { %>
              <div class="alert alert-warning mb-4">
                <h6>
                  <i class="bi bi-exclamation-triangle"></i>
                  プロフィール設定が必要です
                </h6>
                <p class="mb-3">
                  代理店機能を利用するには、まず代理店プロフィールを作成してください。
                </p>
                <a href="/agencies/create-profile" class="btn btn-primary">
                  <i class="bi bi-person-plus"></i> プロフィールを作成
                </a>
              </div>

              <!-- プロフィール未作成時でも指定ページボタンを表示 -->
              <div class="row g-3">
                <div class="col-lg-3 col-md-6">
                  <div
                    class="card h-100"
                    id="admin-url-card-standalone-no-profile"
                    style="display: none"
                  >
                    <div class="card-body text-center">
                      <i
                        class="bi bi-arrow-up-right-square fs-1 text-primary"
                      ></i>
                      <h6 class="card-title mt-2">指定ページ</h6>
                      <p class="card-text text-muted">
                        管理者が設定したページへ
                      </p>
                      <a
                        href="#"
                        id="admin-url-link-standalone-no-profile"
                        target="_blank"
                        class="btn btn-primary"
                      >
                        <i class="bi bi-arrow-up-right-square"></i> ページを開く
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <% } %>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 管理者設定URL取得・表示 -->
    <% if (session && session.user && session.user.role === 'agency') { %>
    <script>
      // 代理店ユーザーのみ管理者設定URLリンクを取得・表示
      console.log("=== 管理者設定URL取得開始（standalone） ===");
      console.log("APIエンドポイント: /settings/api/official-line-url");

      fetch("/settings/api/official-line-url")
        .then((response) => {
          console.log("APIレスポンス状態:", response.status);
          console.log("APIレスポンスOK:", response.ok);
          return response.json();
        })
        .then((data) => {
          console.log("取得したデータ:", data);
          console.log("URL:", data.url);

          if (data.url) {
            console.log("管理者設定URLが設定されています:", data.url);

            // プロフィール作成済み用のボタン
            const linkElement = document.getElementById(
              "admin-url-link-standalone"
            );
            const cardElement = document.getElementById(
              "admin-url-card-standalone"
            );

            // プロフィール未作成用のボタン
            const linkElementNoProfile = document.getElementById(
              "admin-url-link-standalone-no-profile"
            );
            const cardElementNoProfile = document.getElementById(
              "admin-url-card-standalone-no-profile"
            );

            // プロフィール作成済み用ボタンの制御
            if (linkElement && cardElement) {
              linkElement.href = data.url;
              cardElement.style.display = "block";
              console.log("管理者設定URLカード（standalone）を表示しました");
            }

            // プロフィール未作成用ボタンの制御
            if (linkElementNoProfile && cardElementNoProfile) {
              linkElementNoProfile.href = data.url;
              cardElementNoProfile.style.display = "block";
              console.log(
                "管理者設定URLカード（standalone-no-profile）を表示しました"
              );
            }

            // どちらも見つからない場合のエラーログ
            if (
              !linkElement &&
              !cardElement &&
              !linkElementNoProfile &&
              !cardElementNoProfile
            ) {
              console.error("HTML要素が見つかりません:", {
                linkElement: !!linkElement,
                cardElement: !!cardElement,
                linkElementNoProfile: !!linkElementNoProfile,
                cardElementNoProfile: !!cardElementNoProfile,
              });
            }
          } else {
            console.log("管理者設定URLが設定されていません");
          }
        })
        .catch((error) => {
          console.error("管理者設定URL取得エラー:", error);
        });
    </script>
    <% } %>
  </body>
</html>
