<% layout('layout', { title: title, session: session }) %>
<div class="card shadow-sm p-4 mb-4">
  <h1 class="mb-4">管理者ダッシュボード</h1>
  <p class="text-muted">
    代理店管理システムへようこそ。以下の機能をご利用いただけます。
  </p>

  <!-- メイン機能 -->
  <div class="row g-3 mb-5">
    <div class="col-md-4">
      <div class="card h-100 border-primary">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-people-fill"></i> 代理店管理</h5>
        </div>
        <div class="card-body">
          <p class="card-text">
            代理店の一覧表示、新規登録、プロフィール管理を行います。
          </p>
          <a href="/agencies/list" class="btn btn-primary">代理店一覧</a>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100 border-success">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> 売上管理</h5>
        </div>
        <div class="card-body">
          <p class="card-text">各代理店の売上データを確認・管理します。</p>
          <a href="/sales/list" class="btn btn-success">売上一覧</a>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100 border-info">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-collection"></i> グループ管理</h5>
        </div>
        <div class="card-body">
          <p class="card-text">代理店をグループ別に整理・管理します。</p>
          <a href="/groups/list" class="btn btn-info">グループ管理</a>
        </div>
      </div>
    </div>
  </div>

  <!-- システム設定 -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">
            <i class="bi bi-gear-fill"></i> システム設定・テスト
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- メール設定テスト -->
            <div class="col-md-6">
              <h6><i class="bi bi-envelope"></i> メール通知テスト</h6>
              <p class="text-muted small">
                代理店プロフィール登録時のメール通知機能をテストします。
              </p>
              <button
                id="testEmailBtn"
                class="btn btn-outline-warning btn-sm"
                onclick="testEmail()"
              >
                <i class="bi bi-send"></i> テストメール送信
              </button>
              <div id="emailTestResult" class="mt-2"></div>
            </div>

            <!-- システム情報 -->
            <div class="col-md-6">
              <h6><i class="bi bi-info-circle"></i> システム情報</h6>
              <ul class="list-unstyled small text-muted">
                <li>• メール通知: 代理店プロフィール登録・更新時に自動送信</li>
                <li>• 設定方法: README_EMAIL_SETUP.mdを参照</li>
                <li>• 環境変数: .envファイルでSMTP設定を行ってください</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  async function testEmail() {
    const btn = document.getElementById("testEmailBtn");
    const result = document.getElementById("emailTestResult");

    // ボタンを無効化
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 送信中...';

    try {
      const response = await fetch("/agencies/test-email", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      const data = await response.json();

      if (data.success) {
        result.innerHTML = `
        <div class="alert alert-success alert-sm">
          <i class="bi bi-check-circle"></i> ${data.message}
        </div>
      `;
      } else {
        result.innerHTML = `
        <div class="alert alert-danger alert-sm">
          <i class="bi bi-exclamation-triangle"></i> ${data.message}
        </div>
      `;
      }
    } catch (error) {
      result.innerHTML = `
      <div class="alert alert-danger alert-sm">
        <i class="bi bi-exclamation-triangle"></i> 通信エラーが発生しました: ${error.message}
      </div>
    `;
    } finally {
      // ボタンを有効化
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-send"></i> テストメール送信';
    }
  }
</script>
