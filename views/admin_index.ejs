<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>管理者ダッシュボード - 店舗管理システム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </head>
  <body class="container py-5">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">店舗管理システム</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <% if (typeof session !== 'undefined' && session && session.user &&
            session.user.role === 'admin') { %>
            <li class="nav-item">
              <a class="nav-link" href="/stores/list">店舗一覧</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups/list">グループ管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users/list">アカウント管理</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/settings">
                <i class="bi bi-gear"></i> システム設定
              </a>
            </li>
            <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && session.user.role === 'agency') { %>
            <li class="nav-item">
              <a class="nav-link text-warning" href="/auth/promote"
                >管理者・役員に切り替え</a
              >
            </li>
            <% if (session.user.store_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/stores/profile/<%= session.user.store_id %>"
                >マイプロフィール</a
              >
            </li>
            <% } %>
            <li class="nav-item">
              <a class="nav-link" href="/sales/list">売上管理</a>
            </li>
            <% if (session.user.store_id) { %>
            <li class="nav-item">
              <a
                class="nav-link"
                href="/materials/<%= session.user.store_id %>"
                >商品資料格納庫</a
              >
            </li>
            <% } %> <% } %> <% if (typeof session !== 'undefined' && session &&
            session.user && (session.user.role === 'admin')) { %> <% } %> <% if
            (typeof session !== 'undefined' && session && session.user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">ログアウト</a>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/auth/login">ログイン</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

    <div class="card shadow-sm p-4 mb-4">
      <h1 class="mb-4">管理者ダッシュボード</h1>
      <p class="text-muted">
        店舗管理システムへようこそ。以下の機能をご利用いただけます。
      </p>

      <!-- メイン機能 -->
      <div class="row g-3 mb-5">
        <div class="col-md-4">
          <div class="card h-100 border-primary">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-people-fill"></i> 店舗管理</h5>
            </div>
            <div class="card-body">
              <p class="card-text">
                店舗の一覧表示、新規登録、プロフィール管理を行います。
              </p>
              <a href="/stores/list" class="btn btn-primary">店舗一覧</a>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card h-100 border-success">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0"><i class="bi bi-graph-up"></i> 売上管理</h5>
            </div>
            <div class="card-body">
              <p class="card-text">各店舗の売上データを確認・管理します。</p>
              <a href="/sales/list" class="btn btn-success">売上一覧</a>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card h-100 border-info">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">
                <i class="bi bi-collection"></i> グループ管理
              </h5>
            </div>
            <div class="card-body">
              <p class="card-text">店舗をグループ別に整理・管理します。</p>
              <a href="/groups/list" class="btn btn-info">グループ管理</a>
            </div>
          </div>
        </div>
      </div>

      <!-- 追加機能 -->
      <div class="row g-3 mb-5">
        <div class="col-md-6">
          <div class="card h-100 border-warning">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="bi bi-shield-lock"></i> アカウント管理
              </h5>
            </div>
            <div class="card-body">
              <p class="card-text">
                管理者アカウントの作成・削除を行います。最大5つまで作成可能。
              </p>
              <a href="/users/list" class="btn btn-warning text-dark">
                <i class="bi bi-people"></i> アカウント管理
              </a>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card h-100 border-secondary">
            <div class="card-header bg-secondary text-white">
              <h5 class="mb-0"><i class="bi bi-folder-fill"></i> 資料管理</h5>
            </div>
            <div class="card-body">
              <p class="card-text">
                商品資料格納庫の管理・ファイルアップロードを行います。
              </p>
              <a href="/materials/" class="btn btn-secondary">
                <i class="bi bi-files"></i> 全体資料を見る
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- システム設定 -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="bi bi-gear-fill"></i> システム設定・テスト
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- メール設定テスト -->
                <div class="col-md-6">
                  <h6><i class="bi bi-envelope"></i> メール通知テスト</h6>
                  <p class="text-muted small">
                    店舗プロフィール登録時のメール通知機能をテストします。<br />
                    <strong>複数の管理者アドレス</strong>に一斉送信されます。
                  </p>
                  <button
                    id="testEmailBtn"
                    class="btn btn-outline-warning btn-sm"
                    onclick="testEmail()"
                  >
                    <i class="bi bi-send"></i> テストメール送信
                  </button>
                  <div id="emailTestResult" class="mt-2"></div>
                </div>

                <!-- システム情報 -->
                <div class="col-md-6">
                  <h6><i class="bi bi-info-circle"></i> システム情報</h6>
                  <ul class="list-unstyled small text-muted">
                    <li>
                      • メール通知: 店舗プロフィール登録・更新時に自動送信
                    </li>
                    <li>
                      • <strong>複数管理者対応</strong>:
                      ADMIN_EMAILSでカンマ区切り設定
                    </li>
                    <li>• 設定方法: README_EMAIL_SETUP.mdを参照</li>
                    <li>• 環境変数: .envファイルでSMTP設定を行ってください</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function testEmail() {
        const btn = document.getElementById("testEmailBtn");
        const result = document.getElementById("emailTestResult");

        // ボタンを無効化
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 送信中...';

        try {
          const response = await fetch("/stores/test-email", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            result.innerHTML = `
            <div class="alert alert-success alert-sm">
              <i class="bi bi-check-circle"></i> ${data.message}
              ${
                data.adminEmails
                  ? "<br><small><strong>送信先:</strong> " +
                    data.adminEmails.join(", ") +
                    "</small>"
                  : ""
              }
            </div>
          `;
          } else {
            result.innerHTML = `
            <div class="alert alert-danger alert-sm">
              <i class="bi bi-exclamation-triangle"></i> ${data.message}
              ${
                data.adminEmails
                  ? "<br><small><strong>設定されている送信先:</strong> " +
                    data.adminEmails.join(", ") +
                    "</small>"
                  : ""
              }
            </div>
          `;
          }
        } catch (error) {
          result.innerHTML = `
          <div class="alert alert-danger alert-sm">
            <i class="bi bi-exclamation-triangle"></i> 通信エラーが発生しました: ${error.message}
          </div>
        `;
        } finally {
          // ボタンを有効化
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-send"></i> テストメール送信';
        }
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
